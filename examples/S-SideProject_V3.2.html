<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <style>
    #background-canvas {
        position: fixed;
        width: 100%;
        height: 100%;
        background-color:black;
        top:0;
        left:0;
    }
  </style>
</head>
<body>
<canvas id="background-canvas" />
<div style="display:none;">
    <img id="watermark" src="img/ixaslogo.jpg" width="300" height="227" />
    <img id="trademark" src="img/Logo_FLUOR.png" width="300" height="227" />
</div>
<script>

    
$(document).ready(function () {

const DATA = {
    ASTROIDS: {
        apis: {
            id: 'apis',
            name: "APIS!",
            text: {
                color: "#FF0000",
                size: 50,
                font: 'Arial'
            },
            location: {
                x: 130,
                y: 500
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#FF0000",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: ['oms', 'ams', 'rms'],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: true,
                        data: [20, 20]
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        // OMS
        oms: {
            id: 'oms',
            name: "OMS",
            text: {
                color: "#095076",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 300,
                y: 450
            },
            height: 0, 
            width: 0, 
            children: {
                ids: ['meldkamer', 'neninsp', 'maxigis', 'timesheet', 'vgm'],
                line: {
                    color: "#FF00FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [], // NOTE: This is only set on one of the associates. notice how in the register object, 'workorder' is not set. setting in both objects will severly impact performance.
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: true,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [250, 60]
                },
                outer: {
                    color: '#FF0000',
                    radius: 320,
                    bbox: [700, 700]
                }
            }
        },
        meldkamer: {
            id: 'meldkamer',
            name: 'Meldkamer',
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 150,
                y: 150
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        neninsp: {
            id: 'neninsp',
            name: 'NEN-Inspections',
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 200,
                y: 350
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        maxigis: {
            id: 'maxigis',
            name: 'MaxiGIS',
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 150,
                y: 650
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        timesheet: {
            id: 'timesheet',
            name: 'Timesheet',
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 650,
                y: 250
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        vgm: {
            id: 'vgm',
            name: "VGM",
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 550,
                y: 750
            },
            height: 0,
            width: 0,
            content: "",
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        
        // AMS
        ams: {
            id: 'ams',
            name: "AMS",
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 1050,
                y: 200
            },
            height: 0,
            width: 0,
            children: {
                ids: ['poschema', 'fmeca', 'expertsys'], 
                line: {
                    color: "#FF0000",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 80,
                    bbox: [150, 50]
                },
                outer: {
                    color: '#FF0000',
                    radius: 270,
                    bbox: [500, 500]
                }
            }
        },
        poschema: {
            id: 'poschema',
            name: "PO+ Schema",
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 1000,
                y: 50
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        fmeca: {
            id: 'fmeca',
            name: "FMECA 2.0",
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 1250,
                y: 150
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        expertsys: {
            id: 'expertsys',
            name: "Expert Systems",
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 1050,
                y: 400
            },
            height: 0,
            width: 0,
            children: {
                ids: [], //'vsn', 'maxigis', 'timesheet', 'nenelapd', 'helohamer'
                line: {
                    color: "#FF00FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [80, 50]
                },
                outer: {
                    color: '#FF0000',
                    radius: 720,
                    bbox: [600, 600]
                }
            }
        },
        
        // RMS
        rms: {
            id: 'rms',
            name: "RMS",
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 1250,
                y: 750
            },
            height: 0,
            width: 0,
            children: {
                ids: ['risicomatrix', 'afwijkingen', 'eisen', 'vtw'],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#FF0000',
                    radius: 720,
                    bbox: [600, 600]
                }
            }
        },
        risicomatrix: {
            id: 'risicomatrix',
            name: "Risico Matrix",
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 1450,
                y: 550
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        afwijkingen: {
            id: 'afwijkingen',
            name: "Afwijkingen",
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 1150,
                y: 550
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        eisen: {
            id: 'eisen',
            name: "Eisen",
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 1050,
                y: 900
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },
        vtw: {
            id: 'vtw',
            name: "VTW",
            text: {
                color: "#000000",
                size: 30,
                font: 'Arial'
            },
            location: {
                x: 1450,
                y: 850
            },
            height: 0,
            width: 0,
            children: {
                ids: [],
                line: {
                    color: "#00FF00",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            associates: {
                ids: [],
                line: {
                    color: "#0000FF",
                    width: 1,
                    maxLength: 220,
                    dashed: {
                        active: false,
                        data: []
                    }
                },
            },
            orbit: {
                gravity: 8.7,
                inner: {
                    color: '#00FF00',
                    radius: 160,
                    bbox: [300, 300]
                },
                outer: {
                    color: '#00FF00',
                    radius: 720,
                    bbox: [300, 300]
                }
            }
        },

    }
}

const DEBUG_MODE = false;
const PAUSED = false;

// canvas
let canvas = document.getElementById("background-canvas");
canvas.width = $(window).width();
canvas.height = $(window).height();
canvas.style.zIndex = -1;
let ctx = canvas.getContext("2d");

// create background
window.backGroundColor =  "#FFFFFF";
let background = window.backGround =  new Background($(window).width(), $(window).height(), Vector2d.zero(), window.backGroundColor);

const watermark = document.getElementById("watermark");
const trademark = document.getElementById("trademark");

//-------------------------------
// Loop
//-------------------------------
function updateBackground() {

    // redraw background
    ctx.save();
    ctx.fillStyle = background.color.getColorString();
    ctx.fillRect(0, 0, background.width, background.height);
    ctx.globalAlpha = 0.4;
    ctx.drawImage(watermark, 0, 0, 605, 605, 0 , 0 - watermark.height/2, 605, 605);
    ctx.drawImage(watermark, 0, 0, 605, 605, (0 + canvas.width) - (watermark.width*1.7), (0 + canvas.height) - (watermark.height*1.2), 605, 605);
    ctx.globalAlpha = 1;
    ctx.restore();
   
    // update the pixels so they contain movement if velocity and/or acceleration is set.
    for (let i = 0; i < background.allPixels.length; i++){
        const currPixel = background.allPixels[i];
        currPixel.update();
        currPixel.bounceEdges(background);
        //currPixel.bounceFromAssociate();
        currPixel.bounceFromParentBBoxOuter();


    }

    // draw a line from each parent to its children and associates.
    for(let i = 0; i < background.allPixels.length; i++){
        const currPixel = background.allPixels[i];
        const currPixelChildren = currPixel.children.objs;
        const currPixelAssociates = currPixel.associates.objs;

        if(currPixelChildren){
            for(let j = 0; j < currPixelChildren.length; j++){
                const currChild = currPixelChildren[j];
                // teken een lijn tussen zichzelf en de child
                ctx.save();
                ctx.strokeStyle = currPixel.children.line.color.getColorString();
                ctx.lineWidth = window.lineWidth;
                ctx.beginPath();
                ctx.moveTo(currPixel.location.x + (currPixel.width/2), currPixel.location.y - (currPixel.height/4));
                ctx.lineTo(currChild.location.x + (currChild.width/2), currChild.location.y - (currChild.height/4));
                ctx.stroke();
                ctx.restore();
            }
        }

        if(currPixelAssociates){
            for(let j = 0; j < currPixelAssociates.length; j++){
                const currAssociate = currPixelAssociates[j];
                // teken een lijn tussen zichzelf en de child
                ctx.save();
                ctx.strokeStyle = currPixel.associates.line.color.getColorString();
                if(currPixel.associates.line.dashed.active){
                    ctx.setLineDash(currPixel.associates.line.dashed.data);
                }
                let offsetX = 0;
                if(currPixel.id === 'apis'){
                    offsetX = -70
                }
                ctx.lineWidth = window.lineWidth;
                ctx.beginPath();
                ctx.moveTo(currPixel.location.x + (currPixel.width/2) + offsetX, currPixel.location.y - (currPixel.height/4));
                ctx.lineTo(currAssociate.location.x + (currAssociate.width/2), currAssociate.location.y - (currAssociate.height/4));
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.restore();
            }
        }
    }

    // draw the pixel
    for (let i = 0; i < background.allPixels.length; i++){
        const currPixel = background.allPixels[i];

        // draw the pixel background
        ctx.save();
        ctx.translate(currPixel.location.x, currPixel.location.y);

        // draw the pixel name
        ctx.fillStyle = currPixel.text.color.getColorString();
        ctx.font = `${currPixel.text.size}px ${currPixel.text.font}`;
        
        

        if(currPixel.id === 'apis'){
            const offsetX = 0;
            ctx.drawImage(trademark, 0, 0, 442, 518, (-221/2) + offsetX, -259/2, 221, 259);
        }else{
            ctx.fillText(currPixel.name, 0, 0);
        }
            

        ctx.restore();

    }

    // draw orbital circles
    if(!DEBUG_MODE) return;
    for (let i = 0; i < background.allPixels.length; i++){
        const currPixel = background.allPixels[i];
        const currPixelChildren = currPixel.children.objs;

        if(currPixelChildren.length <= 0) continue;
        // draw inner orbital circle
        ctx.save();
        ctx.strokeStyle = currPixel.orbit.inner.color.getColorString();
        ctx.lineWidth = window.lineWidth;
        ctx.translate(currPixel.location.x, currPixel.location.y);
        ctx.beginPath();
        ctx.arc(currPixel.width/2, -currPixel.height/2, currPixel.orbit.inner.radius, 0, Math.PI * 2, true); // circle
        ctx.stroke();
        ctx.restore();

        // draw outer orbital circle
        ctx.save();
        ctx.strokeStyle = currPixel.orbit.outer.color.getColorString();
        ctx.lineWidth = window.lineWidth;
        ctx.translate(currPixel.location.x, currPixel.location.y);
        ctx.beginPath();
        //ctx.arc(currPixel.width/2, -currPixel.height/2, currPixel.orbit.outer.radius, 0, Math.PI * 2, true); // circle
        ctx.stroke();
        ctx.restore();


        // draw outer orbital boundrybox
        ctx.save();
        ctx.strokeStyle = currPixel.orbit.outer.color.getColorString();
        ctx.lineWidth = window.lineWidth;
        ctx.translate(currPixel.location.x, currPixel.location.y);
        ctx.strokeRect(currPixel.width/2 - (currPixel.orbit.outer.bbox[0]/2), -(currPixel.height/2) + -(currPixel.orbit.outer.bbox[1]/2), currPixel.orbit.outer.bbox[0], currPixel.orbit.outer.bbox[1]);
        ctx.restore();

        // draw inner orbital boundry box
        ctx.save();
        ctx.strokeStyle = currPixel.orbit.inner.color.getColorString();
        ctx.lineWidth = window.lineWidth;
        ctx.translate(currPixel.location.x, currPixel.location.y);
        ctx.strokeRect(currPixel.width/2 - (currPixel.orbit.inner.bbox[0]/2), -(currPixel.height/2) + -(currPixel.orbit.inner.bbox[1]/2), currPixel.orbit.inner.bbox[0], currPixel.orbit.inner.bbox[1]);
        ctx.restore();

    }
}


function initializeBackground(){
    
    // line settings
    window.lineWidth =  1;
    window.lineColor =  "#00FF00";
    window.lineLengthBetweenPixels = 220;

    //setting pixel
    const pixelDataKeys = Object.keys(DATA.ASTROIDS);
    const pixelData = DATA.ASTROIDS;
    
    for (let i = 0; i < pixelDataKeys.length; i++){
        const currPixel = pixelData[pixelDataKeys[i]];
        const currAstroid = new Astroid(currPixel);
        
        ctx.font = `${currPixel.text.size}px ${currPixel.text.font}`;
        // set the width based on the text.
        const textWidth = ctx.measureText(currAstroid.name).width;
        currAstroid.width = textWidth;

        // set the heigth based on text size.
        const textHeight = ctx.measureText('M').width; // a very close estimate 
        currAstroid.height = textHeight;
        
        ctx.restore();

        currAstroid.acceleration = Vector2d.zero();
        currAstroid.velocity = PAUSED ? Vector2d.zero() : Vector2d.random(); // makes them move randomly around the screen.
        if( currAstroid.id === 'apis'){
            currAstroid.velocity = Vector2d.zero();
            currAstroid.location.x = canvas.width/2;
            currAstroid.location.y = canvas.height/2;
        }
        
        background.allPixels.push(currAstroid);
    }


    
    for (let i = 0; i < pixelDataKeys.length; i++){
        const currPixel = pixelData[pixelDataKeys[i]];
        const parentAstroid = background.findPixelById(currPixel.id)

        // set children for each astroid
        for(let j = 0; j < currPixel.children.ids.length; j++){
            const currPixelChildId = currPixel.children.ids[j];
            const currPixelChild = background.findPixelById(currPixelChildId)
            parentAstroid.children.objs.push(currPixelChild);
        }

        // set associates for each astroid
        for(let j = 0; j < currPixel.associates.ids.length; j++){
            const currPixelAssociateId = currPixel.associates.ids[j];
            const currPixelAssociate = background.findPixelById(currPixelAssociateId)
            parentAstroid.associates.objs.push(currPixelAssociate);
        }
    }

    // setting canvas on rezise
    window.onresize = function (event) {
        if (event) {
            ctx.canvas.width = $(window).width(); //window.innerWidth;
            ctx.canvas.height = $(window).height(); //window.innerHeight;
            background.refreshCanvas();
        }
    };
    
    setInterval(updateBackground, 20);
}
initializeBackground();

});



// Basic objects
class Sprite{
    constructor(width, height){
        this.width = width;
        this.height = height;
    }
    setHexAsColor(hex){
        let color = Color.hexToRgb(hex);
        this.color = new Color(color.r, color.g, color.b, 1);
    }
    getColor(){
        return this.color;
    }
    // TODO Take this out.
    static hexToRgb(hex) {
        // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
        let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        hex = hex.replace(shorthandRegex, function(m, r, g, b) {
            return r + r + g + g + b + b;
        });

        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }
}

class Pixel extends Sprite{
    constructor(data){
        super(data.width, data.height);
        this.location = new Vector2d(data.location.x, data.location.y);
        this.velocity = data.velocity;
        this.acceleration = data.acceleration;
        this.alive = true;
    }
    update(){
        this.velocity.add(this.acceleration);
        //this.velocity.limit(topspeed);
        this.location.add(this.velocity);
    };
    setHeight(height){
        this.height = height;
    };
    setWidth(width){
        this.width = width;
    };
}

class Spawner extends Sprite{
    constructor(width, height, location){
        super(width, height);
        this.allPixels = [];
        this.location = location;
    }
    addPixel(pixel){
        this.allPixels.push(pixel);
    }
    removePixels(deadPixelContainer){
        for(let i = 0; i < deadPixelContainer.length; i++){
            try{
                let pixelContainer = this.allPixels.slice();
                pixelContainer.splice(this.allPixels.findIndex(v => v === deadPixelContainer[i]), 1).slice();
                this.allPixels = pixelContainer.slice();
                //console.log("Cleaning...");
            }catch(e){
                console.log(e);
            }
        }
    }
    hover(mousePosition){
        return mousePosition.x > this.location.x
            && mousePosition.x < this.location.x + this.width
            && mousePosition.y > this.location.y
            && mousePosition.y < this.location.y + this.height;
        
    }
}

// Custom objects
class Astroid extends Pixel{
    constructor(astroidData){
        super(astroidData);
        this.id = astroidData.id;
        this.name = astroidData.name;

        // the children of this object
        const childrenLineColor = new Color();
        childrenLineColor.setColorHex(astroidData.children.line.color)
        this.children = {
            objs: [],
            line: {
                color: childrenLineColor,
                width: astroidData.children.line.width,
                maxLength: astroidData.children.line.maxLength,
                dashed: {
                    active: astroidData.children.line.dashed.active,
                    data: astroidData.children.line.dashed.data
                }
            }
        };
        
        // associates of this object (Object that act a little diffrently than children)
        const associateLineColor = new Color();
        associateLineColor.setColorHex(astroidData.associates.line.color)
        this.associates = {
            objs: [],
            line: {
                color: associateLineColor,
                width: astroidData.associates.line.width,
                maxLength: astroidData.associates.line.maxLength,
                dashed: {
                    active: astroidData.associates.line.dashed.active,
                    data: astroidData.associates.line.dashed.data
                }
            }
        };
        
        // text style data
        const textColor = new Color();
        textColor.setColorHex(astroidData.text.color)
        this.text = {
            color: textColor,
            size: astroidData.text.size,
            font: astroidData.text.font
        }
        
        // orbital data
        const innerOrbitColor = new Color();
        innerOrbitColor.setColorHex(astroidData.orbit.inner.color);
        const outerOrbitColor = new Color();
        outerOrbitColor.setColorHex(astroidData.orbit.outer.color);
        this.orbit = {
            gravity: astroidData.orbit.gravity, // not yet used in any way.
            inner: {
                color: innerOrbitColor,
                radius: astroidData.orbit.inner.radius,
                mass: astroidData.orbit.inner.radius * 0.1,
                bbox: astroidData.orbit.inner.bbox
            },
            outer: {
                color: outerOrbitColor,
                radius: astroidData.orbit.outer.radius,
                mass: astroidData.orbit.outer.radius * 0.1,
                bbox: astroidData.orbit.outer.bbox
            }

        }
    }
    getChildById(id){
        const result = this.children.find(x => x.id === id);
        return result;
    }
    /*
    the pixel bounces of the border and gos at the same speed and acceleration.
    */
    bounceEdges(background){

        // mirror on the x axis
        if (this.location.x + this.width > background.width) {
            // Mirror the acceleration
            this.acceleration.x = -this.acceleration.x;
            // Mirror the velocity
            this.velocity.x = -this.velocity.x;
        } else if (this.location.x < 0) {
            // Mirror the acceleration
            this.acceleration.x = -this.acceleration.x;
            // Mirror the velocity
            this.velocity.x = -this.velocity.x;
        }
        
        // mirror on the y axis
        if (this.location.y  > background.height) { // bounce from bottom of screen
            // Mirror the acceleration
            this.acceleration.y = -this.acceleration.y;
            // Mirror the velocity
            this.velocity.y = -this.velocity.y;
        } else if (this.location.y - this.height < 0) { // bounce from top of screen
            // Mirror the acceleration
            this.acceleration.y = -this.acceleration.y;
            // Mirror the velocity
            this.velocity.y = -this.velocity.y;
        }
    }
    
    isCollidingWith(circle) {
        const dx = (this.location.x + this.width/2) - (circle.location.x + circle.width/2);
        const dy = this.location.y - circle.location.y;
        const dr = this.orbit.inner.radius + circle.orbit.inner.radius;
        
        const squaredDistance = Math.pow(dx, 2) + Math.pow(dy, 2);

        return squaredDistance < Math.pow(dr, 2);
    }
    bounceFromAssociate(){
        const locationSelf = new Vector2d(this.location.x, this.location.y);
        
        for(let i = 0; i < this.associates.objs.length; i++){
            const currAssociate = this.associates.objs[i];
            const locationCurrAss = new Vector2d(currAssociate.location.x, currAssociate.location.y);

            let distanceVect = Vector2d.sub(currAssociate.location, this.location);
            let distanceVectMag = distanceVect.mag();
            let minDistance = this.orbit.inner.radius + currAssociate.orbit.inner.radius;

            //console.log("min dist: ", minDistance)
            //console.log("dist mag: ", distanceVectMag)

            const result = this.isCollidingWith(currAssociate);
            if(result){
                
                let distanceCorrection = (minDistance - distanceVectMag) / 2.0;

                let d = distanceVect.copy();

                let correctionVector = d.norm();
                correctionVector.mult(distanceCorrection);

                currAssociate.location.add(correctionVector);
                this.location.sub(correctionVector);

                // get angle of distanceVect
                let theta = distanceVect.heading();

                
                // precalculate trig values
                let sine = Math.sin(theta);
                let cosine = Math.cos(theta);

                //bTemp will hold rotated ball this.positions.
                let bTemp = [new Vector2d(), new Vector2d()];

                bTemp[1].x = cosine * distanceVect.x + sine * distanceVect.y;
                bTemp[1].y = cosine * distanceVect.y - sine * distanceVect.x;

                // rotate Temporary velocities
                let vTemp = [new Vector2d(), new Vector2d()];

                vTemp[0].x = cosine * this.velocity.x + sine * this.velocity.y;
                vTemp[0].y = cosine * this.velocity.y - sine * this.velocity.x;
                vTemp[1].x = cosine * currAssociate.velocity.x + sine * currAssociate.velocity.y;
                vTemp[1].y = cosine * currAssociate.velocity.y - sine * currAssociate.velocity.x;

                //calculate the final this.velocity along the x-axis.
                let vFinal = [new Vector2d(), new Vector2d()];

                // final rotated this.velocity for b[0]
                const massSelf = this.orbit.inner.mass;
                const massAss = currAssociate.orbit.inner.mass;
                vFinal[0].x = ((massSelf - massAss) * vTemp[0].x + 2 * massAss * vTemp[1].x) / (massSelf + massAss);
                vFinal[0].y = vTemp[0].y;
                vFinal[1].x = ((massAss - massSelf) * vTemp[1].x + 2 * massSelf * vTemp[0].x) / (massSelf + massAss);
                vFinal[1].y = vTemp[1].y;

                // hack to avoid clumping
                bTemp[0].x += vFinal[0].x;
                bTemp[1].x += vFinal[1].x;

                let bFinal = [new Vector2d(), new Vector2d()];

                bFinal[0].x = cosine * bTemp[0].x - sine * bTemp[0].y;
                bFinal[0].y = cosine * bTemp[0].y + sine * bTemp[0].x;
                bFinal[1].x = cosine * bTemp[1].x - sine * bTemp[1].y;
                bFinal[1].y = cosine * bTemp[1].y + sine * bTemp[1].x;

                console.log(bFinal);

                // update balls to screen this.position
                currAssociate.location.x = this.location.x + bFinal[1].x;
                currAssociate.location.y = this.location.y + bFinal[1].y;

                this.location.add(bFinal[0]);

                // update velocities
                this.velocity.x = cosine * vFinal[0].x - sine * vFinal[0].y;
                this.velocity.y = cosine * vFinal[0].y + sine * vFinal[0].x;
                currAssociate.velocity.x = cosine * vFinal[1].x - sine * vFinal[1].y;
                currAssociate.velocity.y = cosine * vFinal[1].y + sine * vFinal[1].x;
            }
        }
    }
    
    bounceFromParentBBoxOuter(){
        const bboxTop = (this.location.y - this.height/2) - this.orbit.outer.bbox[1]/2;
        const bboxBottom = (this.location.y - this.height) + this.orbit.outer.bbox[1]/2;

        const bboxLeft = (this.location.x + this.height/2) - this.orbit.outer.bbox[0]/2;
        const bboxRight = (this.location.x + this.height) + this.orbit.outer.bbox[0]/2;

        for(let i = 0; i < this.children.objs.length; i++){
            const currChild = this.children.objs[i];
            // minus cause its up

            const childTop = currChild.location.y - currChild.height;
            const childBottom = currChild.location.y;
            const childLeft = currChild.location.x - currChild.width;
            const childRight = currChild.location.x;

            const speed = Math.random();
            const rememberVelCurrChild = new Vector2d(currChild.velocity.x, currChild.velocity.y)
            if(childTop < bboxTop){
                currChild.location.y = bboxTop + currChild.height + 1;
                currChild.velocity.y = this.velocity.y + speed;
            }
            if(childBottom > bboxBottom){
                currChild.location.y = bboxBottom - 1;
                currChild.velocity.y = this.velocity.y - speed;
            }
            if(childLeft < bboxLeft){
                currChild.location.x = bboxLeft + currChild.width + 1;
                currChild.velocity.x = this.velocity.x + speed;
            }
            if(childRight > bboxRight){
                currChild.location.x = bboxRight - 1;
                currChild.velocity.x = this.velocity.x - speed;
            }
        }
    }
    
   
    
    /*
    The pixel enters to the oposite of the screen after going over the edge of the screen.
    */
    jumpEdges(background) {
        if (this.location.x > background.width) {
            this.location.x = 0;
        } else if (this.location.x < 0) {
            this.location.x = background.width;
        }
        if (this.location.y > background.height) {
            this.location.y = 0;
        } else if (this.location.y < 0) {
            this.location.y = background.height;
        }
    }
}

class Background extends Spawner{
    constructor(width, height, location, color){
        super(width, height, location);
        this.allPixels = [];
        this.pixelCount = 160;
        this.setHexAsColor(color);
        this.isPaused = true;
    }
    clearPixels(ctx){
        this.allPixels.length = 0;
        this.pixelCount = 0;
        ctx.fillStyle = this.color.getColorString();
        ctx.fillRect(0, 0, this.width, this.height);
    };
    getRandomLocation(){
        let minWidth = this.location.x;
        let maxWidth = this.location.x + this.width;
        let minHeight = this.location.y;
        let maxHeight = this.location.y + this.height;
        let randomWidthLocation = Math.random() * (maxWidth - minWidth + 1)+minWidth;
        let randomHeightLocation = Math.random() * (maxHeight - minHeight + 1) + minHeight;
        return new Vector2d(randomWidthLocation, randomHeightLocation);
    }
    restart(){
        this.allPixels.length = 0;
        this.pixelCount = 160;
        // empty background of Pixels
        if(this.allPixels.length > 0){
            this.allPixels.length = 0;
        }
        this.start();
    };
    refreshCanvas(){
        this.width = $(window).width();
        this.height = $(window).height();
    };
    pause(){
        this.isPaused = true;
    };
    start(){
        this.isPaused = false;
    }
    findPixelById(id){
        const result = this.allPixels.find(x => x.id === id);
        return result;
    }
}

// Standard objects
class Color{
    constructor(r,g,b,o = 1){
        this.red = r;
        this.green = g;
        this.blue = b;
        this.opacity = o;
    }
    getColorString(){
        return "rgba("+this.red+","+this.green+","+this.blue+","+this.opacity+")";
    }
    setColorHex(hex){
        let rgb = Color.hexToRgb(hex);
        this.red = rgb.r;
        this.green = rgb.g;
        this.blue = rgb.b;
    }
    getColorHex(){
        return Color.rgbToHex(this.red, this.green, this.blue);
    }
    static rgbToHex(r, g, b) {
        return "#" + Color.componentToHex(r) + Color.componentToHex(g) + Color.componentToHex(b);
    }
    static componentToHex(c) {
        let hex = c.toString(16);
        return hex.length === 1 ? "0" + hex : hex;
    }
    static hexToRgb(hex) {
        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }
}

class Vector2d{
    constructor(x = 0, y = 0){
        this.x = x;
        this.y = y;
    }
    add(vector2d) {
        this.x += vector2d.x;
        this.y += vector2d.y;
    };
    sub(vector2d) {
        this.x -= vector2d.x;
        this.y -= vector2d.y;
    };
    mult(mult) {
        this.x *= mult;
        this.y *= mult;
    };
    div(div) {
        this.x /= div;
        this.y /= div;
    };
    mag() {
        return Math.sqrt(this.x * this.x, this.y * this.y);
    };
    norm() {
        const mag = this.mag();
        return new Vector2d(this.x/mag, this.y/mag);
    };
    heading(){
        var h = Math.atan2(this.y, this.x);
        return h;
    }
    /**
     * Get a copy of this object. 
     * @returns {Vector2d} Returns a copy of this.
     */ 
    copy(){
        return new Vector2d(this.x, this.y);
    }
    /**
     * Subtract two Vector2d's from eachother.
     * @param   {Vector2d} v1 
     * @param   {Vector2d} v2 
     * @returns {Vector2d}      Contains a new Vector2d with combined values.
     */
    static sub(v1, v2){
        return new Vector2d(v1.x - v2.x, v1.y - v2.y);
    }
    static zero(){
        return new Vector2d(0,0);
    };
    static random(multiplier = 1){
        // return a random Vector2d
        let vector;
        let random = Math.random();
        if (random <= 0.25) {
            vector = new Vector2d(-Math.random() * multiplier, -Math.random() * multiplier);
        } else if (random > 0.25 && random <= 0.5) {
            vector = new Vector2d(-Math.random() * multiplier, Math.random() * multiplier);
        } else if (random > 0.5 && random <= 0.75) {
            vector = new Vector2d(Math.random() * multiplier, -Math.random() * multiplier);
        } else {
            vector = new Vector2d(Math.random() * multiplier, Math.random() * multiplier);
        }
        return vector;
    }
}


</script>
</body>
</html>